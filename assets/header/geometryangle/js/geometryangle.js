//============================================================
//
// Copyright below.
// 
// CoAuthor: Patrick Geyer
//
// Twitter: https://twitter.com/PatrickGeyer_
//
//============================================================

FSS={FRONT:0,BACK:1,DOUBLE:2,SVGNS:"http://www.w3.org/2000/svg"},FSS.Array="function"==typeof Float32Array?Float32Array:Array,FSS.Utils={isNumber:function(t){return!isNaN(parseFloat(t))&&isFinite(t)}},function(){for(var t=0,e=["ms","moz","webkit","o"],i=0;i<e.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,i){var r=(new Date).getTime(),n=Math.max(0,16-(r-t)),o=window.setTimeout(function(){e(r+n)},n);return t=r+n,o}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}(),Math.PIM2=2*Math.PI,Math.PID2=Math.PI/2,Math.randomInRange=function(t,e){return t+(e-t)*Math.random()},Math.clamp=function(t,e,i){return t=Math.max(t,e),t=Math.min(t,i)},FSS.Vector3={create:function(t,e,i){var r=new FSS.Array(3);return this.set(r,t,e,i),r},clone:function(t){var e=this.create();return this.copy(e,t),e},set:function(t,e,i,r){return t[0]=e||0,t[1]=i||0,t[2]=r||0,this},setX:function(t,e){return t[0]=e||0,this},setY:function(t,e){return t[1]=e||0,this},setZ:function(t,e){return t[2]=e||0,this},copy:function(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],this},add:function(t,e){return t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],this},addVectors:function(t,e,i){return t[0]=e[0]+i[0],t[1]=e[1]+i[1],t[2]=e[2]+i[2],this},addScalar:function(t,e){return t[0]+=e,t[1]+=e,t[2]+=e,this},subtract:function(t,e){return t[0]-=e[0],t[1]-=e[1],t[2]-=e[2],this},subtractVectors:function(t,e,i){return t[0]=e[0]-i[0],t[1]=e[1]-i[1],t[2]=e[2]-i[2],this},subtractScalar:function(t,e){return t[0]-=e,t[1]-=e,t[2]-=e,this},multiply:function(t,e){return t[0]*=e[0],t[1]*=e[1],t[2]*=e[2],this},multiplyVectors:function(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],this},multiplyScalar:function(t,e){return t[0]*=e,t[1]*=e,t[2]*=e,this},divide:function(t,e){return t[0]/=e[0],t[1]/=e[1],t[2]/=e[2],this},divideVectors:function(t,e,i){return t[0]=e[0]/i[0],t[1]=e[1]/i[1],t[2]=e[2]/i[2],this},divideScalar:function(t,e){return 0!==e?(t[0]/=e,t[1]/=e,t[2]/=e):(t[0]=0,t[1]=0,t[2]=0),this},cross:function(t,e){var i=t[0],r=t[1],n=t[2];return t[0]=r*e[2]-n*e[1],t[1]=n*e[0]-i*e[2],t[2]=i*e[1]-r*e[0],this},crossVectors:function(t,e,i){return t[0]=e[1]*i[2]-e[2]*i[1],t[1]=e[2]*i[0]-e[0]*i[2],t[2]=e[0]*i[1]-e[1]*i[0],this},min:function(t,e){return t[0]<e&&(t[0]=e),t[1]<e&&(t[1]=e),t[2]<e&&(t[2]=e),this},max:function(t,e){return t[0]>e&&(t[0]=e),t[1]>e&&(t[1]=e),t[2]>e&&(t[2]=e),this},clamp:function(t,e,i){return this.min(t,e),this.max(t,i),this},limit:function(t,e,i){var r=this.length(t);return null!==e&&r<e?this.setLength(t,e):null!==i&&r>i&&this.setLength(t,i),this},dot:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},normalise:function(t){return this.divideScalar(t,this.length(t))},negate:function(t){return this.multiplyScalar(t,-1)},distanceSquared:function(t,e){var i=t[0]-e[0],r=t[1]-e[1],n=t[2]-e[2];return i*i+r*r+n*n},distance:function(t,e){return Math.sqrt(this.distanceSquared(t,e))},lengthSquared:function(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]},length:function(t){return Math.sqrt(this.lengthSquared(t))},setLength:function(t,e){var i=this.length(t);return 0!==i&&e!==i&&this.multiplyScalar(t,e/i),this},floor:function(t){return t[0]=Math.floor(t[0]),t[1]=Math.floor(t[1]),t[2]=Math.floor(t[2]),t}},FSS.Vector4={create:function(t,e,i,r){var n=new FSS.Array(4);return this.set(n,t,e,i),n},set:function(t,e,i,r,n){return t[0]=e||0,t[1]=i||0,t[2]=r||0,t[3]=n||0,this},setX:function(t,e){return t[0]=e||0,this},setY:function(t,e){return t[1]=e||0,this},setZ:function(t,e){return t[2]=e||0,this},setW:function(t,e){return t[3]=e||0,this},add:function(t,e){return t[0]+=e[0],t[1]+=e[1],t[2]+=e[2],t[3]+=e[3],this},multiplyVectors:function(t,e,i){return t[0]=e[0]*i[0],t[1]=e[1]*i[1],t[2]=e[2]*i[2],t[3]=e[3]*i[3],this},multiplyScalar:function(t,e){return t[0]*=e,t[1]*=e,t[2]*=e,t[3]*=e,this},min:function(t,e){return t[0]<e&&(t[0]=e),t[1]<e&&(t[1]=e),t[2]<e&&(t[2]=e),t[3]<e&&(t[3]=e),this},max:function(t,e){return t[0]>e&&(t[0]=e),t[1]>e&&(t[1]=e),t[2]>e&&(t[2]=e),t[3]>e&&(t[3]=e),this},clamp:function(t,e,i){return this.min(t,e),this.max(t,i),this}},FSS.Color=function(t,e){this.rgba=[],this.color=t||"#000000",this.opacity=FSS.Utils.isNumber(e)?e:1,this.set(this.color,this.opacity)},FSS.Color.prototype={set:function(t,e){if(-1===t.indexOf("#")){if(0===t.indexOf("rgb(")){var i=t.indexOf(",");this.rgba[0]=parseInt(t.substr(4,i)),this.rgba[1]=parseInt(t.substr(i+1,t.indexOf(",",i))),this.rgba[2]=parseInt(t.substr(t.indexOf(",",i+1)+1,t.indexOf(")"))),this.rgba[3]=1}else if(0===t.indexOf("rgba(")){i=t.indexOf(",");var r=t.indexOf(",",i+1);this.rgba[0]=parseInt(t.substr(5,i)),this.rgba[1]=parseInt(t.substr(i+1,r)),this.rgba[2]=parseInt(t.substr(t.indexOf(",",i+1)+1,t.indexOf(",",r))),this.rgba[3]=parseFloat(t.substr(t.indexOf(",",r+1)+1,t.indexOf(")")))}}else{var n=(t=t.replace("#","")).length/3;this.rgba[0]=parseInt(t.substring(0*n,1*n),16)/255,this.rgba[1]=parseInt(t.substring(1*n,2*n),16)/255,this.rgba[2]=parseInt(t.substring(2*n,3*n),16)/255,this.rgba[3]=FSS.Utils.isNumber(e)?e:this.rgba[3]}return this},format:function(){return"rgba("+this.rgba[0]+","+this.rgba[1]+","+this.rgba[2]+","+this.rgba[3]+")"}},FSS.Object=function(){this.position=FSS.Vector3.create()},FSS.Object.prototype={setPosition:function(t,e,i){return FSS.Vector3.set(this.position,t,e,i),this}},FSS.Light=function(t,e){FSS.Object.call(this),this.ambient=new FSS.Color(t||"#FFFFFF"),this.diffuse=new FSS.Color(e||"#FFFFFF"),this.ray=FSS.Vector3.create()},FSS.Light.prototype=Object.create(FSS.Object.prototype),FSS.Vertex=function(t,e,i){this.position=FSS.Vector3.create(t,e,i)},FSS.Vertex.prototype={setPosition:function(t,e,i){return FSS.Vector3.set(this.position,t,e,i),this}},FSS.Triangle=function(t,e,i){this.a=t||new FSS.Vertex,this.b=e||new FSS.Vertex,this.c=i||new FSS.Vertex,this.vertices=[this.a,this.b,this.c],this.u=FSS.Vector3.create(),this.v=FSS.Vector3.create(),this.centroid=FSS.Vector3.create(),this.normal=FSS.Vector3.create(),this.color=new FSS.Color,this.polygon=document.createElementNS(FSS.SVGNS,"polygon"),this.polygon.setAttributeNS(null,"stroke-linejoin","round"),this.polygon.setAttributeNS(null,"stroke-miterlimit","1"),this.polygon.setAttributeNS(null,"stroke-width","1"),this.computeCentroid(),this.computeNormal()},FSS.Triangle.prototype={computeCentroid:function(){return this.centroid[0]=this.a.position[0]+this.b.position[0]+this.c.position[0],this.centroid[1]=this.a.position[1]+this.b.position[1]+this.c.position[1],this.centroid[2]=this.a.position[2]+this.b.position[2]+this.c.position[2],FSS.Vector3.divideScalar(this.centroid,3),this},computeNormal:function(){return FSS.Vector3.subtractVectors(this.u,this.b.position,this.a.position),FSS.Vector3.subtractVectors(this.v,this.c.position,this.a.position),FSS.Vector3.crossVectors(this.normal,this.u,this.v),FSS.Vector3.normalise(this.normal),this}},FSS.Geometry=function(){this.vertices=[],this.triangles=[],this.dirty=!1},FSS.Geometry.prototype={update:function(){if(this.dirty){var t,e;for(t=this.triangles.length-1;t>=0;t--)(e=this.triangles[t]).computeCentroid(),e.computeNormal();this.dirty=!1}return this}},FSS.Plane=function(t,e,i,r){FSS.Geometry.call(this),this.width=t||100,this.height=e||100,this.segments=i||4,this.slices=r||4,this.segmentWidth=this.width/this.segments,this.sliceHeight=this.height/this.slices;var n,o,s,a,h,l,c,u=[],S=-.5*this.width,f=.5*this.height;for(n=0;n<=this.segments;n++)for(u.push([]),o=0;o<=this.slices;o++)c=new FSS.Vertex(S+n*this.segmentWidth,f-o*this.sliceHeight),u[n].push(c),this.vertices.push(c);for(n=0;n<this.segments;n++)for(o=0;o<this.slices;o++)s=u[n+0][o+0],a=u[n+0][o+1],h=u[n+1][o+0],l=u[n+1][o+1],t0=new FSS.Triangle(s,a,h),t1=new FSS.Triangle(h,a,l),this.triangles.push(t0,t1)},FSS.Plane.prototype=Object.create(FSS.Geometry.prototype),FSS.Material=function(t,e){this.ambient=new FSS.Color(t||"rgba(68,68,68, 1)"),this.diffuse=new FSS.Color(e||"rgba(255,255,255, 1)"),this.slave=new FSS.Color},FSS.Mesh=function(t,e){FSS.Object.call(this),this.geometry=t||new FSS.Geometry,this.material=e||new FSS.Material,this.side=FSS.FRONT,this.visible=!0},FSS.Mesh.prototype=Object.create(FSS.Object.prototype),FSS.Mesh.prototype.update=function(t,e){var i,r,n,o,s,a;if(a=t.length,this.geometry.update(),e)for(i=this.geometry.triangles.length-1;i>=0;i--){for(r=this.geometry.triangles[i],FSS.Vector4.set(r.color.rgba),n=t.length-1;n>=0;n--){o=t[n],FSS.Vector3.subtractVectors(o.ray,o.position,r.centroid),FSS.Vector3.normalise(o.ray),s=FSS.Vector3.dot(r.normal,o.ray),this.side===FSS.FRONT?s=Math.max(s,0):this.side===FSS.BACK?s=Math.abs(Math.min(s,0)):this.side===FSS.DOUBLE&&(s=Math.max(Math.abs(s),0));for(var h=0;h<3;h++)this.material.slave.rgba[h]=1/a*this.material.ambient.rgba[h]*(1/a*o.ambient.rgba[h])/128,3!==h&&(this.material.slave.rgba[h]=Math.round(this.material.slave.rgba[h]));FSS.Vector4.add(r.color.rgba,this.material.slave.rgba);for(h=0;h<3;h++)this.material.slave.rgba[h]=1/a*this.material.diffuse.rgba[h]*(1/a)*o.diffuse.rgba[h]/128,3!==h&&(this.material.slave.rgba[h]=Math.round(this.material.slave.rgba[h]));for(h=0;h<3;h++)this.material.slave.rgba[h]=Math.round(this.material.slave.rgba[h]*s);FSS.Vector4.add(r.color.rgba,this.material.slave.rgba)}FSS.Vector4.clamp(r.color.rgba,0,255),r.color.rgba[3]=this.material.diffuse.rgba[3]}return this},FSS.Scene=function(){this.meshes=[],this.lights=[]},FSS.Scene.prototype={add:function(t){return t instanceof FSS.Mesh&&!~this.meshes.indexOf(t)?this.meshes.push(t):t instanceof FSS.Light&&!~this.lights.indexOf(t)&&this.lights.push(t),this},remove:function(t){return t instanceof FSS.Mesh&&~this.meshes.indexOf(t)?this.meshes.splice(this.meshes.indexOf(t),1):t instanceof FSS.Light&&~this.lights.indexOf(t)&&this.lights.splice(this.lights.indexOf(t),1),this}},FSS.Renderer=function(){this.width=0,this.height=0,this.halfWidth=0,this.halfHeight=0},FSS.Renderer.prototype={setSize:function(t,e){if(this.width!==t||this.height!==e)return this.width=t,this.height=e,this.halfWidth=.5*this.width,this.halfHeight=.5*this.height,this},clear:function(){return this},render:function(t){return this}},FSS.CanvasRenderer=function(){FSS.Renderer.call(this),this.element=document.createElement("canvas"),this.element.style.zIndex="-100",this.element.style.pointerEvents="none",this.context=this.element.getContext("2d"),this.setSize(this.element.width,this.element.height)},FSS.CanvasRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.CanvasRenderer.prototype.setSize=function(t,e){return FSS.Renderer.prototype.setSize.call(this,t,e),this.element.width=t,this.element.height=e,this.context.setTransform(1,0,0,1,0,0),this},FSS.CanvasRenderer.prototype.clear=function(){return FSS.Renderer.prototype.clear.call(this),this.context.clearRect(0,0,this.width,this.height),this};var opacity=[];FSS.CanvasRenderer.prototype.render=function(t){var e,i,r,n,o;FSS.Renderer.prototype.render.call(this,t);var s=2*Math.PI;for(this.clear(),this.context.lineJoin="round",this.context.lineWidth=0,e=t.meshes.length-1;e>=0;e--)if(i=t.meshes[e],void 0===opacity[e]&&(opacity[e]=[]),i.visible)for(i.update(t.lights,!0),r=i.geometry.triangles.length-1;r>=0;r--){var a=Date.now();if(void 0===opacity[e][r]?(opacity[e][r]={},opacity[e][r].step=FSS.Vector3.create(Math.randomInRange(.2,1),Math.randomInRange(.2,1),Math.randomInRange(.2,1)),opacity[e][r].time=Math.randomInRange(0,Math.PIM2),opacity[e][r].line=0):(opacity[e][r].line=Math.sin(opacity[e][r].time+opacity[e][r].step[0]*a*(t.LINE.fluctuationSpeed/100))*t.LINE.fluctuationIntensity,opacity[e][r].vertex=Math.sin(opacity[e][r].time+opacity[e][r].step[0]*a*(t.VERTEX.fluctuationSpeed/100))*t.VERTEX.fluctuationIntensity,opacity[e][r].mesh=Math.sin(opacity[e][r].time+opacity[e][r].step[0]*a*(t.MESH.fluctuationSpeed/100))*t.MESH.fluctuationIntensity),n=i.geometry.triangles[r],!1!==t.MESH.draw&&(o="rgba("+(h=n.color.rgba)[0]+","+h[1]+", "+h[2]+","+h[3]+")",this.context.beginPath(),this.context.moveTo(n.a.position[0],n.a.position[1]),this.context.lineTo(n.b.position[0],n.b.position[1]),this.context.lineTo(n.c.position[0],n.c.position[1]),this.context.closePath(),this.context.fillStyle=o,this.context.fill()),!1!==t.LINE.draw)(h=(h=new FSS.Color(t.LINE.fill)).rgba)[3]=h[3]*(1-opacity[e][r].line),h="rgba("+h[0]+","+h[1]+", "+h[2]+","+h[3]+")",this.context.beginPath(),this.context.moveTo(n.a.position[0],n.a.position[1]),this.context.lineTo(n.b.position[0],n.b.position[1]),this.context.lineWidth=t.LINE.thickness,this.context.fillStyle=h,this.context.fill(),this.context.strokeStyle=h,this.context.stroke();if(!1!==t.VERTEX.draw){var h;(h=(h=new FSS.Color(t.VERTEX.fill)).rgba)[3]=h[3]*(1-opacity[e][r].vertex),h="rgba("+h[0]+","+h[1]+", "+h[2]+","+h[3]+")";var l=new FSS.Color(t.VERTEX.strokeColor);(l=l.rgba)[3]=l[3]*(1-opacity[e][r].vertex),l="rgba("+l[0]+","+l[1]+", "+l[2]+","+l[3]+")",this.context.beginPath(),this.context.arc(n.a.position[0],n.a.position[1],t.VERTEX.radius,0,s,!1),this.context.fillStyle=h,this.context.fill(),this.context.lineWidth=t.VERTEX.strokeWidth,this.context.strokeStyle=l,this.context.stroke()}}return this},FSS.WebGLRenderer=function(){FSS.Renderer.call(this),this.element=document.createElement("canvas"),this.element.style.display="block",this.vertices=null,this.lights=null;if(this.gl=this.getContext(this.element,{preserveDrawingBuffer:!1,premultipliedAlpha:!0,antialias:!0,stencil:!0,alpha:!0}),this.unsupported=!this.gl,this.unsupported)return"WebGL is not supported by your browser.";this.gl.clearColor(0,0,0,0),this.gl.enable(this.gl.DEPTH_TEST),this.setSize(this.element.width,this.element.height)},FSS.WebGLRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.WebGLRenderer.prototype.getContext=function(t,e){var i=!1;try{if(!(i=t.getContext("experimental-webgl",e)))throw"Error creating WebGL context."}catch(t){console.error(t)}return i},FSS.WebGLRenderer.prototype.setSize=function(t,e){if(FSS.Renderer.prototype.setSize.call(this,t,e),!this.unsupported)return this.element.width=t,this.element.height=e,this.gl.viewport(0,0,t,e),this},FSS.WebGLRenderer.prototype.clear=function(){if(FSS.Renderer.prototype.clear.call(this),!this.unsupported)return this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this},FSS.WebGLRenderer.prototype.render=function(t){if(FSS.Renderer.prototype.render.call(this,t),!this.unsupported){var e,i,r,n,o,s,a,h,l,c,u,S,f,d,g,m=!1,p=t.lights.length,b=0;if(this.clear(),this.lights!==p){if(this.lights=p,!(this.lights>0))return;this.buildProgram(p)}if(this.program){for(e=t.meshes.length-1;e>=0;e--)(i=t.meshes[e]).geometry.dirty&&(m=!0),i.update(t.lights,!1),b+=3*i.geometry.triangles.length;if(m||this.vertices!==b){this.vertices=b;for(h in this.program.attributes){for((c=this.program.attributes[h]).data=new FSS.Array(b*c.size),f=0,e=t.meshes.length-1;e>=0;e--)for(r=0,n=(i=t.meshes[e]).geometry.triangles.length;r<n;r++)for(d=0,g=(o=i.geometry.triangles[r]).vertices.length;d<g;d++){switch(vertex=o.vertices[d],h){case"side":this.setBufferData(f,c,i.side);break;case"position":this.setBufferData(f,c,vertex.position);break;case"centroid":this.setBufferData(f,c,o.centroid);break;case"normal":this.setBufferData(f,c,o.normal);break;case"ambient":this.setBufferData(f,c,i.material.ambient.rgba);break;case"diffuse":this.setBufferData(f,c,i.material.diffuse.rgba)}f++}this.gl.bindBuffer(this.gl.ARRAY_BUFFER,c.buffer),this.gl.bufferData(this.gl.ARRAY_BUFFER,c.data,this.gl.DYNAMIC_DRAW),this.gl.enableVertexAttribArray(c.location),this.gl.vertexAttribPointer(c.location,c.size,this.gl.FLOAT,!1,0,0)}}for(this.setBufferData(0,this.program.uniforms.resolution,[this.width,this.height,this.width]),s=p-1;s>=0;s--)a=t.lights[s],this.setBufferData(s,this.program.uniforms.lightPosition,a.position),this.setBufferData(s,this.program.uniforms.lightAmbient,a.ambient.rgba),this.setBufferData(s,this.program.uniforms.lightDiffuse,a.diffuse.rgba);for(l in this.program.uniforms)switch(S=(c=this.program.uniforms[l]).location,u=c.data,c.structure){case"3f":this.gl.uniform3f(S,u[0],u[1],u[2]);break;case"3fv":this.gl.uniform3fv(S,u);break;case"4fv":this.gl.uniform4fv(S,u)}}return this.gl.drawArrays(this.gl.TRIANGLES,0,this.vertices),this}},FSS.WebGLRenderer.prototype.setBufferData=function(t,e,i){if(FSS.Utils.isNumber(i))e.data[t*e.size]=i;else for(var r=i.length-1;r>=0;r--)e.data[t*e.size+r]=i[r]},FSS.WebGLRenderer.prototype.buildProgram=function(t){if(!this.unsupported){var e=FSS.WebGLRenderer.VS(t),i=FSS.WebGLRenderer.FS(t),r=e+i;if(!this.program||this.program.code!==r){var n=this.gl.createProgram(),o=this.buildShader(this.gl.VERTEX_SHADER,e),s=this.buildShader(this.gl.FRAGMENT_SHADER,i);if(this.gl.attachShader(n,o),this.gl.attachShader(n,s),this.gl.linkProgram(n),!this.gl.getProgramParameter(n,this.gl.LINK_STATUS)){var a=this.gl.getError(),h=this.gl.getProgramParameter(n,this.gl.VALIDATE_STATUS);return console.error("Could not initialise shader.\nVALIDATE_STATUS: "+h+"\nERROR: "+a),null}return this.gl.deleteShader(s),this.gl.deleteShader(o),n.code=r,n.attributes={side:this.buildBuffer(n,"attribute","aSide",1,"f"),position:this.buildBuffer(n,"attribute","aPosition",3,"v3"),centroid:this.buildBuffer(n,"attribute","aCentroid",3,"v3"),normal:this.buildBuffer(n,"attribute","aNormal",3,"v3"),ambient:this.buildBuffer(n,"attribute","aAmbient",4,"v4"),diffuse:this.buildBuffer(n,"attribute","aDiffuse",4,"v4")},n.uniforms={resolution:this.buildBuffer(n,"uniform","uResolution",3,"3f",1),lightPosition:this.buildBuffer(n,"uniform","uLightPosition",3,"3fv",t),lightAmbient:this.buildBuffer(n,"uniform","uLightAmbient",4,"4fv",t),lightDiffuse:this.buildBuffer(n,"uniform","uLightDiffuse",4,"4fv",t)},this.program=n,this.gl.useProgram(this.program),n}}},FSS.WebGLRenderer.prototype.buildShader=function(t,e){if(!this.unsupported){var i=this.gl.createShader(t);return this.gl.shaderSource(i,e),this.gl.compileShader(i),this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)?i:(console.error(this.gl.getShaderInfoLog(i)),null)}},FSS.WebGLRenderer.prototype.buildBuffer=function(t,e,i,r,n,o){var s={buffer:this.gl.createBuffer(),size:r,structure:n,data:null};switch(e){case"attribute":s.location=this.gl.getAttribLocation(t,i);break;case"uniform":s.location=this.gl.getUniformLocation(t,i)}return o&&(s.data=new FSS.Array(o*r)),s},FSS.WebGLRenderer.VS=function(t){return["precision mediump float;","#define LIGHTS "+t,"attribute float aSide;","attribute vec3 aPosition;","attribute vec3 aCentroid;","attribute vec3 aNormal;","attribute vec4 aAmbient;","attribute vec4 aDiffuse;","uniform vec3 uResolution;","uniform vec3 uLightPosition[LIGHTS];","uniform vec4 uLightAmbient[LIGHTS];","uniform vec4 uLightDiffuse[LIGHTS];","varying vec4 vColor;","void main() {","vColor = vec4(0.0);","vec3 position = aPosition / uResolution * 2.0;","for (int i = 0; i < LIGHTS; i++) {","vec3 lightPosition = uLightPosition[i];","vec4 lightAmbient = uLightAmbient[i];","vec4 lightDiffuse = uLightDiffuse[i];","vec3 ray = normalize(lightPosition - aCentroid);","float illuminance = dot(aNormal, ray);","if (aSide == 0.0) {","illuminance = max(illuminance, 0.0);","} else if (aSide == 1.0) {","illuminance = abs(min(illuminance, 0.0));","} else if (aSide == 2.0) {","illuminance = max(abs(illuminance), 0.0);","}","vColor += aAmbient * lightAmbient;","vColor += aDiffuse * lightDiffuse * illuminance;","}","vColor = clamp(vColor, 0.0, 1.0);","gl_Position = vec4(position, 1.0);","}"].join("\n")},FSS.WebGLRenderer.FS=function(t){return["precision mediump float;","varying vec4 vColor;","void main() {","gl_FragColor = vColor;","}"].join("\n")},FSS.SVGRenderer=function(){FSS.Renderer.call(this),this.element=document.createElementNS(FSS.SVGNS,"svg"),this.element.setAttribute("xmlns",FSS.SVGNS),this.element.setAttribute("version","1.1"),this.element.style.display="block",this.setSize(300,150)},FSS.SVGRenderer.prototype=Object.create(FSS.Renderer.prototype),FSS.SVGRenderer.prototype.setSize=function(t,e){return FSS.Renderer.prototype.setSize.call(this,t,e),this.element.setAttribute("width",t),this.element.setAttribute("height",e),this},FSS.SVGRenderer.prototype.clear=function(){FSS.Renderer.prototype.clear.call(this);for(var t=this.element.childNodes.length-1;t>=0;t--)this.element.removeChild(this.element.childNodes[t]);return this},FSS.SVGRenderer.prototype.render=function(t){var e,i,r,n,o,s;for(FSS.Renderer.prototype.render.call(this,t),e=t.meshes.length-1;e>=0;e--)if((i=t.meshes[e]).visible)for(i.update(t.lights,!0),r=i.geometry.triangles.length-1;r>=0;r--)(n=i.geometry.triangles[r]).polygon.parentNode!==this.element&&this.element.appendChild(n.polygon),o=this.formatPoint(n.a)+" ",o+=this.formatPoint(n.b)+" ",o+=this.formatPoint(n.c),s=this.formatStyle(n.color.format()),n.polygon.setAttributeNS(null,"points",o),n.polygon.setAttributeNS(null,"style",s);return this},FSS.SVGRenderer.prototype.formatPoint=function(t){return t.position[0]+","+t.position[1]},FSS.SVGRenderer.prototype.formatStyle=function(t){var e="fill:"+t+";";return e+="stroke:"+t+";"},function(){$.fn.Geometryangle=function(e){for(var i,r=[],n=$(this),o=n.length,s=0;s<o;s++)i=n[s],r[r.length]=t(e,i);return 1==r.length?r[0]:r};var t=function(t,e){t=t||{};var i={},r=[{}],n={},o={},s={width:1.2,height:1.2,depth:10,columns:void 0,columns_auto:!0,rows:void 0,rows_auto:!0,zoom:1,xRange:.8,yRange:.1,zRange:1,ambient:"rgba(0, 0, 0, 1)",diffuse:"rgba(50, 50, 50, 1)",background:"rgba(255, 255, 255, 1)",speed:2e-4,fluctuationSpeed:.5,fluctuationIntensity:0,onRender:function(){},floorPosition:!1,draw:!0},a={radius:0,fill:"rgba(0, 0, 0, 0)",fluctuationSpeed:.5,fluctuationIntensity:0,strokeWidth:0,strokeColor:"rgba(0, 0, 0, 0)",draw:!1},h={fill:"rgba(0, 0, 0, 0)",thickness:1,fluctuationIntensity:0,fluctuationSpeed:.5,draw:!1},c={count:1,xyScalar:1,zOffset:100,ambient:"rgba(255,255,255,0.01)",diffuse:"rgba(255,255,255,0.01)",speed:.01,gravity:1200,dampening:.95,minLimit:10,maxLimit:null,minDistance:20,maxDistance:400,autopilot:!1,draw:!1,bounds:FSS.Vector3.create(),step:FSS.Vector3.create(Math.randomInRange(.2,1),Math.randomInRange(.2,1),Math.randomInRange(.2,1))},u=e,S=function(t){t.mesh=t.mesh||i,t.lights=t.lights||r,t.vertex=t.vertex||n,t.line=t.line||o,i=$.extend(!0,s,i,t.mesh),n=$.extend(!0,a,n,t.vertex),o=$.extend(!0,h,o,t.line);for(var e=0;e<r.length;e++)r[e]=$.extend(!0,c,r[e],t.lights[e]);var l,S,f,d=(l=u,S=[[],[]],f=[i,r],$.each(f,function(t){$.each(f[t],function(e,i){if(void 0!==l.getAttribute("data-fss-"[e])&&!1!==typeof l.getAttribute("data-fss-"+[e])){try{return S[t][e]=$.parseJSON(l.getAttribute("data-fss-"+[e])),!0}catch(t){}"object"!=typeof S[t][e]&&(S[t][e]=l.getAttribute("data-fss-"+[e]))}});var e=void 0!==l.getAttribute("data-fss")&&!1!==typeof l.getAttribute("data-fss")?$.parseJSON(l.getAttribute("data-fss")):[];$.extend(!0,S[t],e)}),S);(i=$.extend(!0,d[0],i)).columns_auto=void 0===t.mesh.columns,i.rows_auto=void 0===t.mesh.rows};S({mesh:s,line:h,vertex:a,lights:[c]}),S(t);var f=document.createElement("div");f.style.position="absolute",f.style.left="0",f.style.right="0",f.style.top="0",f.style.bottom="0",f.style.background=i.background,f.style.zIndex="-100",f.setAttribute("class","fss-output"),u.insertBefore(f,null);var d,g,m,p,b,F,v,y,w,x="webgl",V="canvas",R="svg",A={renderer:V},M=Date.now(),L=FSS.Vector3.create(),E=FSS.Vector3.create();document.getElementById("ui");function I(){var t,e;for(m.remove(p),g.clear(),b=new FSS.Plane(i.width*g.width,i.height*g.height,i.columns,i.rows),F=new FSS.Material(i.ambient,i.diffuse),p=new FSS.Mesh(b,F),m.add(p),t=b.vertices.length-1;t>=0;t--)(e=b.vertices[t]).anchor=FSS.Vector3.floor(FSS.Vector3.clone(e.position)),e.step=FSS.Vector3.create(Math.randomInRange(.2,1),Math.randomInRange(.2,1),Math.randomInRange(.2,1)),e.time=Math.randomInRange(0,Math.PIM2)}function N(){var t,e;for(t=m.lights.length-1;t>=0;t--)e=m.lights[t],m.remove(e);for(g.clear(),t=0;t<r.length;t++)for(var i=0;i<r[t].count;i++)e=new FSS.Light(r[t].ambient,r[t].diffuse),m.add(e),e.mass=Math.randomInRange(.5,1),e.velocity=FSS.Vector3.create(),e.acceleration=FSS.Vector3.create(),e.force=FSS.Vector3.create(),e.ring=document.createElementNS(FSS.SVGNS,"circle"),e.ring.setAttributeNS(null,"stroke",e.ambient),e.ring.setAttributeNS(null,"stroke-width","0.5"),e.ring.setAttributeNS(null,"fill","none"),e.ring.setAttributeNS(null,"r","10"),e.core=document.createElementNS(FSS.SVGNS,"circle"),e.core.setAttributeNS(null,"fill",e.diffuseHex),e.core.setAttributeNS(null,"r","4")}var C={resize:function(t,e){void 0!==t&&void 0!==typeof t||(t=u.width()),void 0!==e&&void 0!==typeof e||(e=u.height());var r=t/1e3,n=e/1e3,o=Math.round(10*r)*i.zoom,s=Math.round(10*n)*i.zoom;i.columns=!0===i.columns_auto?o:i.columns,i.rows=!0===i.rows_auto?s:i.rows,g.setSize(t,e),FSS.Vector3.set(L,g.halfWidth,g.halfHeight),I()},update:function(t){for(S(t),m.vertex=n,m.line=o,s=0,l=m.meshes.length;s<l;s++)m.meshes[s].material.ambient.set(i.ambient),m.meshes[s].material.diffuse.set(i.diffuse);b.width!==i.width*g.width&&I(),b.height!==i.height*g.height&&I(),b.segments!==i.columns&&I(),b.slices!==i.rows&&I();var e=0;for(l=0;l<r.length;l++)for(var s=0;s<r[l].count;s++)light=m.lights[e],light.ambient.set(r[l].ambient),light=m.lights[e],light.diffuse.set(r[l].diffuse),e++;m.lights.length!==e&&N()},animateValues:function(t){for(var e=document.body,i=document.documentElement,r=(window.pageYOffset||i.scrollTop)-(i.clientTop||0),n=Math.max(e.scrollHeight,e.offsetHeight,i.clientHeight,i.scrollHeight,i.offsetHeight),o=t.length,s=r%(n=Math.round(n/o))/n,a=t[c=Math.floor(r/n)],h=t[(c+1)%o],l=[],c=0;c<a.length;c++)l[c]=a[c]+(h[c]-a[c])*s,3!==c&&(l[c]=Math.round(l[c]));return l},formatRGBA:function(t){return"rgba("+t[0]+","+t[1]+","+t[2]+","+t[3]+")"}};function P(){d=Date.now()-M,function(){var t,e,n,o,s,a,h,l=i.depth/2,c=0,u=FSS.Vector3.floor(FSS.Vector3.create(g.halfWidth,g.halfHeight,0));for(o=0;o<r.length;o++)for(var S=0;S<r[o].count;S++){if(s=m.lights[c],FSS.Vector3.copy(r[o].bounds,L),FSS.Vector3.multiplyScalar(r[o].bounds,r[o].xyScalar),FSS.Vector3.setZ(E,r[o].zOffset),r[o].autopilot&&void 0===r[o].position&&(t=Math.sin(r[o].step[0]*d*r[o].speed),e=Math.cos(r[o].step[1]*d*r[o].speed),FSS.Vector3.set(E,r[o].bounds[0]*t,r[o].bounds[1]*e,r[o].zOffset)),FSS.Vector3.setZ(s.position,r[o].zOffset),void 0!==r[o].position)FSS.Vector3.set(s.position),FSS.Vector3.add(s.position,FSS.Vector3.create(r[o].position[0],r[o].position[1],r[o].zOffset));else{var f=Math.clamp(FSS.Vector3.distanceSquared(s.position,E),r[o].minDistance,r[o].maxDistance),p=r[o].gravity*s.mass/f;FSS.Vector3.subtractVectors(s.force,E,s.position),FSS.Vector3.normalise(s.force),FSS.Vector3.multiplyScalar(s.force,p),FSS.Vector3.set(s.acceleration),FSS.Vector3.add(s.acceleration,s.force),FSS.Vector3.add(s.velocity,s.acceleration),FSS.Vector3.multiplyScalar(s.velocity,r[o].dampening),FSS.Vector3.limit(s.velocity,r[o].minLimit,r[o].maxLimit),FSS.Vector3.add(s.position,s.velocity)}c++}for(a=b.vertices.length-1;a>=0;a--)h=b.vertices[a],t=Math.sin(h.time+h.step[0]*d*i.speed),e=Math.cos(h.time+h.step[1]*d*i.speed),n=Math.sin(h.time+h.step[2]*d*i.speed),h.position=FSS.Vector3.create(i.xRange*b.segmentWidth*t,i.yRange*b.sliceHeight*e,i.zRange*l*n-l),!0===i.positionFloor&&(h.position=FSS.Vector3.floor(h.position)),FSS.Vector3.add(h.position,h.anchor),FSS.Vector3.add(h.position,u);b.dirty=!0}(),T(),requestAnimationFrame(P)}function T(){var t,e,n,o;if(g.render(m),r.draw)for(t=m.lights.length-1;t>=0;t--)switch(e=(o=m.lights[t]).position[0],n=o.position[1],A.renderer){case V:g.context.lineWidth=.5,g.context.beginPath(),g.context.arc(e,n,10,0,Math.PIM2),g.context.strokeStyle=o.ambient,g.context.stroke(),g.context.beginPath(),g.context.arc(e,n,4,0,Math.PIM2),g.context.fillStyle=o.diffuse,g.context.fill();break;case R:o.core.setAttributeNS(null,"fill",o.diffuse),o.core.setAttributeNS(null,"cx",e),o.core.setAttributeNS(null,"cy",n),g.element.appendChild(o.core),o.ring.setAttributeNS(null,"stroke",o.ambient),o.ring.setAttributeNS(null,"cx",e),o.ring.setAttributeNS(null,"cy",n),g.element.appendChild(o.ring)}i.onRender(m,g.context)}function O(t){FSS.Vector3.set(E,t.x,t.y),r.autopilot=!r.autopilot}function G(t){FSS.Vector3.set(E,t.x,t.y)}function D(t){C.resize(u.offsetWidth,u.offsetHeight),T()}return v=new FSS.WebGLRenderer,y=new FSS.CanvasRenderer,w=new FSS.SVGRenderer,function(t){switch(t){case x:g=v;break;case V:g=y;break;case R:g=w}g.setSize(f.offsetWidth,f.offsetHeight),f.insertBefore(g.element,null);var e=window.getComputedStyle(u);"static"!=e.getPropertyValue("position")&&0!=e.getPropertyValue("position").length||(u.style.position="relative")}(A.renderer),(m=new FSS.Scene).VERTEX=n,m.LINE=o,m.MESH=i,I(),N(),window.attachEvent&&(window.addEventHandler=window.attachEvent),window.addEventListener("resize",D,!1),u.addEventListener("click",O,!1),u.addEventListener("mousemove",G,!0),C.resize(f.offsetWidth,f.offsetHeight),P(),C}}();